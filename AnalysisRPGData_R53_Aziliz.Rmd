---
title: "Analyse du mixte culturale selon région et commune"
author: "Aziliz"
date: "2025-05-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r environment-preparation, include=FALSE}
# Clean memory 
rm(list=ls())
gc()

# Load package
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, data.table, here, sf, tmap, units)

# List directories 
dir <- list()
dir$root <- here()
dir$data <- here(dir$root, "data")
dir$raw <- here(dir$data, "raw")
dir$derived <- here(dir$data, "derived")
dir$script <- here(dir$root, "script")
dir$output <- here(dir$root, "output")
dir$faostat_data <- here(dir$root, "faostat_data")

# Create non existing directories
lapply(dir, function(i) dir.create(i, recursive = T, showWarnings = F))

```

## **Préparation des données**

## **Analyse des données : le cas de la *Bretagne* (R53)**

```{r}
RPG_R53 <- readRDS(here(dir$derived, "groupes_aggregated_R53.rds"))
```

## **Création d'une palette de couleurs contrastées**

```{r}
c25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)

```


### **Statistiques descriptives**

```{r}
summary(RPG_R53)
```

Il semble y avoir des **valeurs extrêmes** dans la répartition des surfaces agricoles cultivées en Bretagne. Cela sa voit par : 
- la moyenne des surfaces agricoles cultivées qui est de 14,9 millions de mètres carrées est supérieure à la médiane qui est de 11,8 millions de mètres carrés. 
- la plus grande surface cultivée est de 110 milliards de mètres carrés.

Notons déjà que les valeures minimales 0.00 en termes de surfaces agricoles cultivées sont normales. En effet, les communes bretonnes ne cultivent pas nécessairement l'entiereté des cultures regroupées dans les libellés du RPG. 

Notons également la part importante que représente la culture agricole dans la région de la Bretagne. Remarquons cela en comparant la médiane de la surface des communes à celle de la surface agricole. 

Plus de la moitié des surfaces communales sont des surfaces agricoles : 20520000 m² de surface totale des communes contre 11856787 m² de surface agricole.

\_Nb - autres remarques\_ : 
- Est-ce étonnant d'avoir un groupe de culture couvrant 100% de la surface agricole d'une commune? Cela amènerait à nuancer la diversité culturale étudiée plus bas. 

A noter que lorsqu'on parle en pourcentage, on se retrouve avec 218 valeurs manquantes, mieux vaut peut-être rester sur une analyse en termes de surface? Ces valeurs manquantes peuvent s'expliquer par la division par un dénominateur nul (N_Parcels, surf_code_group_m2).

```{r}
year_simplified <- c(2007, 2012, 2017, 2023)

RPG_R53_simplified <- RPG_R53 %>%
  filter(year %in% year_simplified)

# Agréger par année et culture
df_parcelles <- RPG_R53_simplified %>%
  group_by(year, LIBELLE_GROUPE_CULTURE) %>%
  summarise(N = sum(N_Parcels, na.rm = TRUE), .groups = "drop")

ggplot(df_parcelles, aes(x = LIBELLE_GROUPE_CULTURE, y = N)) +
  geom_col(fill = "darkgrey") +
  facet_wrap(~ year, ncol = 2) +
  labs(
    title = "Nombre de parcelles par type de culture",
    x = "Type de culture",
    y = "Nombre de parcelles"
  ) +
  coord_flip() +
  theme_minimal()

ggsave(here(dir$output, "nombre_parcelles_culture.png"), width = 10, height = 6)
```


#### \_ Evolution de la surface agricole dans le temps \_

```{r - violin_plot}

RPG_R53 %>%
  ggplot(aes(x = factor(year), y = surf_agri_geo_unit_m2)) +
  geom_violin(fill = "skyblue", color = "black", alpha = 0.7) +
  geom_boxplot(width = 0.1, fill = "white", outlier.shape = NA, color = "black") + # Ajout d'une boîte 
  labs(title = "Distribution de la surface agricole totale par année en Bretagne (2007-2023)",
       x = "Année", y = "Surface agricole totale (m2)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
```

Ce graphique purement descriptif n'apporte pas énormément d'informations mis à part le fait que la part des surfaces agricoles cultivées, dans le temps, en Bretagne, reste relativement stable.
 

D'après la distribution ci-dessus, la majorité des surfaces agricoles cultivées en Bretagne sont inférieures à 30 millions de m², ce qui reflète potentiellement la prédominance de petites et moyennes exploitations agricoles en Bretagne.

A noter qu'en agriculture on parle davantage en hectares qu'en mètres carrés. 
*1 hectare = 10 000 mètres carrés donc 30 000 000 mètres carrés = 3000 hectares.

Nb: il serait alors préférable d'intégrer dans le code une conversion des mètres carrés en hectares. La ligne de code à ajouter serait la suivante : 
**RPG_R53 <- RPG_R53 %>%**
  **mutate(surf_agri_geo_unit_ha = surf_agri_geo_unit_m2 / 10000)**

A noter : j'ai opté pour les mètres carrés car dans l'analyse qui suit, mes comparaisons de surface agricole se font dans cette unité. 
  

### **Parts des différents groupes de cultures dans la surface agricole totale**
```{r}
cultures_groupes <- RPG_R53 %>%
  group_by(year, CODE_GROUP, LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    surface_groupe = sum(surf_code_group_m2),
    parcels_groupe = sum(parcel_cult_code_group_n),
    .groups = "drop") %>%
  arrange(CODE_GROUP, year) %>% 
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE) %>% 
  mutate(
    taux_croissance = (surface_groupe - lag(surface_groupe)) / lag(surface_groupe) * 100,
    taux_croissance_parcels = (parcels_groupe - lag(parcels_groupe)) / lag(parcels_groupe) * 100
  ) %>%
  mutate(
    mean_taux_croissance = mean(taux_croissance, na.rm = TRUE), 
    mean_taux_croissance_parcels = mean(taux_croissance_parcels, na.rm = TRUE))

print(cultures_groupes)

View(cultures_groupes)
```

```{r}
#nombre de groupes de cultures cultivés dans la région
n_code_groups <- n_distinct(RPG_R53$CODE_GROUP)
print(n_code_groups)
```

Parmi les 29 groupes (exception de deux sans numéro de groupes et d'un "NR"), le libellé le plus cultivé en Bretagne est le "Fourrage", les "Légumes ou fleurs" et d'autres céréales avec respectivement : 434 717 400 000 m²  387 088 000 000 m² et 259 097 100 000 m² de surfaces cultivées. 

A l'inverse, la dernière surface pour laquelle nous possédons des données est le riz avec une surface cultivée faible : 26 125 m².

Ainsi, les agriculteurs bretons cultivent principalement des légumes, des céréales et du fourrage (pour nourrir les bêtes). 

#### \_Graphique évolution des groupes de culture dans la surface agricole totale\_

##### Etude des taux de croissance des surfaces et des parcelles agricoles cultivées, selon les groupes de culture, entre 2007 et 2023.
```{r - taux_croissance_1}
#taux de croissance des surfaces agricoles cultivées
cultures_groupes %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  arrange(year) %>%
  group_by(year, LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(x = year, y = as.numeric(taux_croissance), color = LIBELLE_GROUPE_CULTURE, group = LIBELLE_GROUPE_CULTURE)) +
  geom_point() +
  geom_line() +
  ylim(-100, 300)+
  scale_color_manual(values = c25) +
  labs(title = "Evolution des groupes de culture dans le temps",
       y = "Taux de croissance des surfaces cultivées") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))


#taux de croissance des parcelles cultivées
cultures_groupes %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  arrange(year) %>%
  group_by(year, LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(x = year, y = taux_croissance_parcels, color = LIBELLE_GROUPE_CULTURE, group = LIBELLE_GROUPE_CULTURE)) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) +
  labs(title = "Evolution des groupes de culture dans le temps",
       y = "Taux de croissance des parcelles cultivées") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))
```

Ces deux graphiques illustrent l'évolution des groupes de culture dans le temps selon la surface cultivée ou le nombre de parcelles cultivées qui leur est associé.

Ils sont difficiles à analyser de par la multiplicité des groupes de cultures qui représentent et leur hétérogénéité dans leur variation au cours du temps. 

D'autre part, le choix de zoomer sur le premier graphique (surfaces) a été fait en raison de la dominance d'une seule culture à échelle plus grande, +4000% de croissance pour la vigne, culture qui s'implante en Bretagne tardivement au cours de la période comme cela sera montré par la suite. 

Ainsi, voici quelques grandes analyses descriptives que nous pouvons réaliser : 
* En termes de surfaces cultivées, les courbes se chevauchant autour de 0 pour les cultures les plus stables, il est plus aisé de s'attacher aux cultures qui ont tendance à fluctuer au fil des années. 

Trois cultures ont majoritairement les variations les plus importantes, entre croissance et décroissance, c'est-à-dire entre augmentation de la surface cultivée et diminution, marquées donc par une forme d'instabilité, instabilité dont il s'agiriat par la suite de déterminer les déterminants : les légumineuses à grains (courbe pêche), le tournesol (courbe vert pomme) et les plantes à fibres (courbe rose). Des cultures variant, pour les deux premières, entre -100 et 250, avec des pics à des années différentes. Les pics de décroissance ont majoritairement touchés ces deux cultures entre 2007 et 2015, les plus importants étant en 2012 et 2015. A l'inverse, les pics de croissance ont lieu tout au long de la période avec trois paroxysmes : 2011 et 2019 pour les légumineuses à grains et 2018 pour le tournesol. 

Finalement, notons également l'explosion des autres cultures industrielles et des protéagineux en 2023, dont la surface agricole cultivée augmente de plus de 200%.

* En termes de nombre de parcelles cultivées, les résultats sont tout autre. 

Nous pouvons tout d'abord noter qu'il y tout au long de la période augmentation et diminution du nombre de parcelles cultivées ce qui indique qu'il n'y a pas de pertes de disparition de parcelles agricoles par exemple, ou qu'elles sont marginales. Néanmoins, il semble que la croissance des parcelles prend le dessus sur la décroissance. A noter que cela n'est pas nécessairement synonyme d'augmentation des espaces cultivées, car nous n'avons pas d'informations sur la taille de ces parcelles. 

D'autre part, les taux de croissance du nombre de parcelles cultivées par groupe de culture, explosent en 2015, ce qui constitue clairement un artefact statistique. En effet, ce pic soudain d'augmentation du nombre de parcelles cultivées semble inhérent au changement de méthode de mesure parcellaire : passant d'îlots anonymes à cutures parcellaires. Nous analyserons par la suite les variations sur deux sous-périodes distinctes. 

Ce qui ressort de ce graphique, c'est qu'il y a une augmentation depuis 2017 du nombre de parcelles cultivées de tournesol tout comme de plantes à fibre depuis 2020 et que récemment les protéagineux et les cultures industrielles se sont vus attribuer un plus grand nombre de parcelles, avec une croissance d'environ 200%, protégaineux dont le nombre de parcelles cultivées avait par ailleurs explosé en 2010 (+350%) avant de revenir sur une forme de stabilité, signifiant ainsi que le nombre de parcelles cultivées de protéagnieux s'est vu renforcé, étant donné qu'il n'y a pas de décroissance qui compense cette croissance soudaine au cours de la période.

##### Etude des taux de croissance moyen des surfaces et des parcelles agricoles cultivées, selon les groupes de culture, entre 2007 et 2023.

Si les taux de croissance nous informe sur les fluctuations annuelles des cultures, les taux de croissance moyen nous donne une indication sur la tendance générale des cultures au cours du temps.

Cela nous permet notamment de comparer la tendance générale des surfaces cultivées par rapport à celle des parcelles cultivées. 
```{r - mean_taux_croissance_plot}
#Graphique selon la moyenne des taux de croissance des surfaces cultivées des groupes de cultures sur la période 2007-2023
cultures_groupes %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  arrange(year) %>%
  group_by(year, LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(x = year, y = as.numeric(mean_taux_croissance), color = LIBELLE_GROUPE_CULTURE, group = LIBELLE_GROUPE_CULTURE)) +
  geom_point() +
  geom_line() +
  ylim(-100, 300)+
  scale_color_manual(values = c25) +
  labs(title = "Evolution des groupes de culture dans le temps",
       y = "Taux de croissance moyen des surfaces cultivées") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

# Graphique selon la moyenne des taux de croissance du nombre de parcelles cultivées des groupes de cultures sur la période 2007-2023
cultures_groupes %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  arrange(year) %>%
  group_by(year, LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(x = year, y = as.numeric(mean_taux_croissance_parcels), color = LIBELLE_GROUPE_CULTURE, group = LIBELLE_GROUPE_CULTURE)) +
  geom_point() +
  geom_line() +
  ylim(-100, 300)+
  scale_color_manual(values = c25) +
  labs(title = "Evolution des groupes de culture dans le temps",
       y = "Taux de croissance moyen des surfaces cultivées") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))
```

Si nous constatons que quelques cultures se détachent (riz, plantes à fibres, légumineuses à grains, tournseol) du groupe de cultures restant sur une tendance à la stagnation des surfaces cultivées. Pour certaines, en particulier, le riz, ce détachement clair avec environ 50 points de pourcentages de différence avec les plantes à fibres, deuxième culture se détachant le plus en termes de croissance moyenne au cours de la période, est surement du à son implantation tardive (2015) au cours de la période étudiée. 

A noter que potentiellement, à ce stade de l'analyse, même si le riz sera étudié par la suite de manière plus précise, nous pouvons émettre l'hypothèse que le riz n'est pas une culture qui apparaît seulement en 2015 mais bien une culture qui était comprise dans un plus grand sous ensemble de cultures auparavant, lors de la réflexion en termes d'îlots anonymes et ainsi qu'elle émerge comme culture propre avec une analyse plus fine du RPG en termes de cultures parcellaires, à partir de 2015.

Ces tendances générales concordent avec les grands traits que nous avons pu tirer des graphiques illustrant les taux de croissance simples, portant sur le tournesol, les légumineuses à grains ou encore les plantes à fibres. 

Si nous nous attachons à présent au taux de croissance moyen en termes de nombre de parcelles cultivées, nous constatons que le riz n'est plus une culture avec une tendance dominante à la croissance en termes de parcelles cultivées et tend à se fondre dans la masse des autres cultures. Viennent alors à se détacher principalement les plantesà fibres et les vignes. 

La non prégnance du riz sur ce second graphique vient confirmer l'idée que le riz reste une culture minoritaire, qui se concentrent sur un certain nombre, limité de parcelles et qui ne vient pas exploser même si sur le premier graphique elle semble dominante de par sa tendance générale à une croissance en termes de surface cultivée au cours du temps.

A l'inverse, il semble qu'il y ait un véritable intérêt pour les plantes à fibre dont la culture tend en moyenne à croître tant en termes de surface cultivée et que de nombre de parcelles.  

Finalement nous proposons ici de réaliser un graphique combinant les taux de croissance moyens aux taux de croissance annuels des surfaces et parcelles cultivées selon les groupes de culture. Cette approche est intéressante car elle permet d'obtenir un graphique de bilan sur les analyses réalisées ci-dessus. Cependant, il s'avère que ce graphique n'est pas aisé à lire et analyser au vue de la multiplicité des informations qu'il présente. Il nécessite donc d'être lu en ayant en tête les analyses précédentes.
```{r - combined_plot}
# Graphique combinant l'analyse selon les taux de croissance des surfaces cultivées par groupe de culture, qui permet de voir les variations annuelles, et selon les taux de croissance moyens des surfaces cultivées par groupe de culture qui permet de voir la tendance générale des groupes de cultures sur la période
cultures_groupes %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  ggplot(aes(x = year, y = as.numeric(taux_croissance), color = LIBELLE_GROUPE_CULTURE, group = LIBELLE_GROUPE_CULTURE)) +
  geom_line(alpha = 0.3) +  # Lignes pour les fluctuations annuelles
  geom_point(alpha = 0.5) + # Points pour les fluctuations annuelles
  geom_hline(aes(yintercept = as.numeric(mean_taux_croissance), color = LIBELLE_GROUPE_CULTURE), linetype = "dashed", size = 0.8) + # Ligne moyenne
  ylim(-100, 300) +
  scale_color_manual(values = c25) +
  labs(
    title = "Fluctuations annuelles et moyennes des groupes de culture",
    y = "Taux de croissance des surfaces cultivées"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

# Idem pour le nombre de parcelles cultivées
cultures_groupes %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  ggplot(aes(x = year, y = as.numeric(taux_croissance_parcels), color = LIBELLE_GROUPE_CULTURE, group = LIBELLE_GROUPE_CULTURE)) +
  geom_line(alpha = 0.3) +  # Lignes pour les fluctuations annuelles
  geom_point(alpha = 0.5) + # Points pour les fluctuations annuelles
  geom_hline(aes(yintercept = as.numeric(mean_taux_croissance_parcels), color = LIBELLE_GROUPE_CULTURE), linetype = "dashed", size = 0.8) + # Ligne moyenne
  ylim(-100, 300) +
  scale_color_manual(values = c25) +
  labs(
    title = "Fluctuations annuelles et moyennes des groupes de culture",
    y = "Taux de croissance du nombre de parcelles cultivées"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

```

##### Etude des 10 groupes de culture qui ont un taux de croissance moyen le plus élevé (en termes de surfaces cultivées puis en termes de nombre de parcelles cultivées) puis le plus faible
\_ But \_ : s'attacher à un nombre restreint de groupes de cultures pour obtenir un graphique plus visible et avoir une analyse plus fine.

```{r}
# Visualisation top 10 des groupes de culture qui ont le plus cru sur la période 2007-2023, en moyenne 
#Calcul du taux de croissance moyen sur la variable binaire 
top_10_cultures <- cultures_groupes %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  group_by(LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    mean_taux_croissance = mean(taux_croissance, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_taux_croissance)) %>%
  slice(1 : 10) # Sélection des 10 premiers

# Filtrer pour ne garder que les cultures sélectionnées
filtered_data <- cultures_groupes %>%
  filter(LIBELLE_GROUPE_CULTURE %in% top_10_cultures$LIBELLE_GROUPE_CULTURE)

filtered_data %>%
  ggplot(aes(
    x = year,
    y = as.numeric(taux_croissance),
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  labs(
    title = "Évolution des 10 cultures avec le taux de croissance moyen le plus élevé",
    y = "Taux de croissance des surfaces cultivées",
    x = "Année"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Visualisation du top 10 des groupes de cultures qui ont le moins cru sur la période 2007-2023, en moyenne
#Calcul du taux de croissance moyen sur la variable binaire 
top_10_cultures_last <- cultures_groupes %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  group_by(LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    mean_taux_croissance = mean(taux_croissance, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(mean_taux_croissance) %>%
  slice(1 : 10) # Sélection des 10 premiers

# Filtrer pour ne garder que les cultures sélectionnées
filtered_data <- cultures_groupes %>%
  filter(LIBELLE_GROUPE_CULTURE %in% top_10_cultures_last$LIBELLE_GROUPE_CULTURE)

filtered_data %>%
  ggplot(aes(
    x = year,
    y = as.numeric(taux_croissance),
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  labs(
    title = "Évolution des 10 cultures avec le taux de croissance moyen le plus faible",
    y = "Taux de croissance des surfaces cultivées",
    x = "Année"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Nous ne commenterons pas davantage les graphiques obtenus ci-dessus car ils ne sont pas les plus pertinents. En effet, cette analyse a été réalisée plus tard dans ce document en distinguant deux sous-groupes selon la méthode des organismes utilisée pour recenser les données parcellaires et les résultats obtenus semblent meilleurs. Le choix de garder ces graphiques ici est soutenu par la volonté de montrer l'intérêt d'étudier les variations sur deux sous-périodes pour obtenir des analyses collant au mieux à la réalité parcellaire de la région. 

Ci-dessous, l'analyse d'un exemple de différence de lecture entre les deux approches (période complète VS sous-périodes) : 

La tendance générale des "autres oléagineux" (courbe rouge) est plutôt stable entre 2010 et 2023, autour de -75% de croissance. Seulement lorsqu'on regarde le graphique qui découpe en deux sous-périodes notre période (voir plus bas), on constate que la remarque précédente est vrai entre 2007 et 2012 mais l'est moins entre 2015 et 2023, période durant laquelle les autres oléagineux ont une tendance à décroître de manière moins importante, avec un seul pic de décroissance atteint en 2022, -37%.

### **Evolution des différents groupes de cultures dans le temps**
```{r}
cultures_groupes2 <- RPG_R53 %>%
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE, year) %>%
  summarise(surface_groupe = sum(surf_code_group_m2))

print(cultures_groupes2)

top_cultures_par_an <- cultures_groupes2 %>% 
  group_by(year) %>% 
  slice_max(surface_groupe, n = 3)

print(top_cultures_par_an)
```

De 2007 à 2015, les cultures les plus cultivées (en surface), en Bretagne étaient les "légumes ou fleurs", les "autres céréales" et le "maïs grain et ensillage". Une dynamique qui change quelque peu à partir de 2015 et jusque 2023 : avec le fourrage qui se place en tête du classement au détriment du "Maïs grain et ensillage". 
**A noter que cet effet coincide avec le changement de méthode de calcul du RPG (passage d'ilôts anonymes à parcels cultivés)...**

#### \_Nuage de points avec taille proportionnelle à la surface agricole\_

```{r - diagramme_dispersion}
plot(
  cultures_groupes$year, 
  cultures_groupes$CODE_GROUP, 
  cex = cultures_groupes$surface_groupe / max(cultures_groupes$surface_groupe, na.rm = TRUE) * 5,  
  col = factor(cultures_groupes$CODE_GROUP),
  xlab = "Année",
  ylab = "Groupe de culture",
  main = "Nuage de points avec taille proportionnelle à la surface agricole",
)
```

Ce graphique nous permet d'analyser plusieurs choses : 
- les cultures dominantes au fil des années en termes de surface agricole occupée : fourrage (16), Légumes ou fleurs (25), Autres céréales (4), Maïs grain et ensillage (2). 
- La variabilité temporelle des cultures : illustration claire d'une fluctuation de la surface agricole associée au fourrage, particulièrement en 2017. 

### **Cultures émergentes/cultures en disparition**
```{r - taux_croissance_2}
#taux de croissance détaillé des groupes de culture au fil des années de la période étudiée
year_by_culture <- RPG_R53 %>%
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE, year) %>%
  summarise(
    annee_min = min(year),
    surface_group = sum(surf_code_group_m2, na.rm = TRUE),
    parcels_cult = sum(parcel_cult_code_group_n, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE) %>%
  mutate(
    annee_min = min(year),
    surface_base = sum(surface_group[year == annee_min], na.rm = TRUE),
    parcels_base = sum(parcels_cult[year == annee_min], na.rm = TRUE),
    taux_croissance_surf = (surface_group - surface_base) / surface_base * 100,
    taux_croissance_parcels = (parcels_cult - parcels_base) / parcels_base * 100,
    nb_annees = n_distinct(year),
  ) %>%
  ungroup()

print(year_by_culture)
```

```{r - taux_croissance_culture_group}
#taux de croissance sur la période de culture
year_by_culture_summary <- RPG_R53 %>%
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    annee_min = min(year),
    annee_max = max(year),
    surface_year_min = sum(surf_code_group_m2[year == min(year)], na.rm = TRUE),
    surface_year_max = sum(surf_code_group_m2[year == max(year)], na.rm = TRUE),
    parcels_year_min = sum(parcel_cult_code_group_n[year == min(year)], na.rm = TRUE),
    parcels_year_max = sum(parcel_cult_code_group_n[year == max(year)], na.rm = TRUE),
    taux_croissance_surf = (surface_year_max - surface_year_min) / surface_year_min * 100,
    taux_croissance_parcels = (parcels_year_max - parcels_year_min) / parcels_year_min * 100,
    .groups = "drop"
  )

print(year_by_culture_summary)
```

La dernière culture a être apparue en Bretagne est la vigne, en 2016. 

Si la majorité des cultures sont des cultures stables, présentes depuis le début de la période, 2007, certaines apparraissent plus tardivement dans la période notamment les oliviers, en 2010 et le riz en 2015. 

#### Il serait intéressant de voir où le riz et les oliviers ont été implantés en Bretagne (nom de la commune)?
```{r}
library(dplyr)

implantations <- RPG_R53 %>%
  filter(LIBELLE_GROUPE_CULTURE %in% c("Oliviers", "Riz"), year >= 2010)

print(implantations)
```

Il faut noter, que les oliviers ne sont cultivés, d'après le RPG, durant une seule année. 
**IMPORTANT : l'implantation de cette culture se fait sur 2 communes : Saint Broladre et Saint Marcan MAIS est associé au nombre de parcelles cultivées d'Oliviers à Saint Broladre : 0 !**
**Nb : problème de nettoyage de données - lié à chevauchement de parcelles entre communes à un seuil < 0,5 - réglé dans le script <05_AggregateData-France>**

Une autre culture se démarque : les légumineuses à grains. Malgré le fait qu'elles couvrent toute la période. Le nombre d'années recensé de leur culture est de 14, cela signifie qu'entre 2007 et 2023, il y a eu une année où il n'y avait pas de cultures de légumineuses à grain sur la surface agricole totale de la Bretagne. 

Nb : Cela peut être soit :
- une piste à creuser afin de déterminer pourquoi les légumineuses à grains n'ont pas été cultivées durant une année 
- un problème dans la base de données ou un facteur externe qui ne s'applique qu'à cette culture et qui peut donc être considéré comme marginal. 

### **Graphique de réprésentation des cultures dans le temps (âge)**

```{r}
#Variation des cultures en Bretagne dans le temps
ggplot(year_by_culture, aes(x = nb_annees, fill = LIBELLE_GROUPE_CULTURE)) +
  geom_bar()
```

Ce graphique illustre le fait que la majorité des cultures traversent l'entiereté de la période etudiée.

Dans celles qui ne recouvrent pas toute la période, on retrouve : les oliviers, le riz, les vignes et les légumineuses à grain. Ce graphique vient seulement illustrer et confirmer les statistiques précédentes sur l'émergence et la disparition des cultures au cours de la période 2007-2023. 

#### \_Etude des groupes de cultures selon des sous-périodes\_

Dans l'anaylse qui suit, nous optons pour une division du groupe en deux "échantillons". En effet, les données dont nous disposons sont issues de deux types de recensement parcellaire : un recensement selon la catégorisation d'îlots anonymes (regroupement d'ensemble de cultures et de parcelles en de plus grands groupes), qui prend fin en 2015 pour laisser place à une catégorisation en cultures parcellaires (analyse plus fine). 

Il s'agit alors d'étudier d'un côté la période 2007-2015 et de l'autre celle 2015-2023, le but étant de se détacher du biais créé par la méthode de calclul des données, biais visible sur les graphiques lors des analyses. 

Pour cela, nous créons une variable binaire.
```{r - binary_croissance_frame}
library(dplyr)
year_by_culture_binary <- RPG_R53 %>%
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE, year) %>%
  summarise(
    surface_group = sum(surf_code_group_m2, na.rm = TRUE),
    parcels_cult = sum(parcel_cult_code_group_n, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    binary_period = ifelse(year > 2015, 1, 0) # 1 = 2007-2015, 0 = 2015-2023
  ) %>%
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE, binary_period) %>%
  mutate(
    # Calcul de l'année de base pour chaque période
    min_year = min(year), 
    surface_base = sum(surface_group[year == min_year], na.rm = TRUE),
    parcels_base = sum(parcels_cult[year == min_year], na.rm = TRUE),
    taux_croissance_surf_binary = (surface_group - surface_base) / surface_base * 100,
    taux_croissance_parcels_binary = (parcels_cult - parcels_base) / parcels_base * 100
  ) %>%
  ungroup()

print(year_by_culture_binary)
```

##### Graphiques à partir des taux de croissance 

Le code suivant crée 4 graphiques. les deux premiers sont ceux qui ne prennent pas en compte la variable bianire, et étudie les taux de croissance sur l'ensemble de la période. Les deux autres sont ceux qui représentent les taux de croissance calculés sur l'une ou l'autre sous-période. 

A noter 1 : si le premier calcul des taux de croissance (voir plus haut) calcule la croissance relative des surfaces et parcelles d'une année à l'autre, ce qui met en avant les variations annuelles, le calcul qui suit mesure la croissance par rapport à une année de référence fixe (année d'implantation), offrant une vision globale de la tendance sur toute la période étudiée.

A noter 2 : petit bémol dans les graphiques sur les sous-périodes, il faudrait modifier l'échelle de la facette correspondant à la sous-période 2007-2015 car elle est basée sur celle de  2015-2023, or les variations n'ont pas du tout la même ampleur, l'étude des variations sur la première période sont donc rendues complexes.
```{r}
#taux de croissance des surfaces cultivées 
year_by_culture %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  arrange(year) %>%
  group_by(annee_min, year, LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(x = year, y = as.numeric(taux_croissance_surf), color = LIBELLE_GROUPE_CULTURE, group = LIBELLE_GROUPE_CULTURE)) +
  geom_point() +
  ylim(0, 4000) +
  geom_line() +
  scale_color_manual(values = c25) +
  labs(title = "Evolution des groupes de culture dans le temps",
       y = "Taux de croissance des surfaces cultivées") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

#taux de croissance du nombre de parcelles cultivées
year_by_culture %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  arrange(year) %>%
  group_by(annee_min, year, LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(x = year, y = taux_croissance_parcels, color = LIBELLE_GROUPE_CULTURE, group = LIBELLE_GROUPE_CULTURE)) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) +
  labs(title = "Evolution des groupes de culture dans le temps",
       y = "Taux de croissance des parcelles cultivées") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

#taux de croissance avec binaire sur les deux périodes : 2007-2015 VS 2015-2023
year_by_culture_binary %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  arrange(year) %>%
  group_by(binary_period, year, LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(
    x = year,
    y = as.numeric(taux_croissance_surf_binary),
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  facet_wrap(~ binary_period, ncol = 1, scales = "free_x") +
  labs(
    title = "Évolution des groupes de culture dans le temps",
    y = "Taux de croissance des surfaces cultivées",
    x = "Année"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    strip.text = element_text(size = 12, face = "bold") # Style des facettes
  )

year_by_culture_binary %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  arrange(year) %>%
  group_by(binary_period, year, LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(
    x = year,
    y = taux_croissance_parcels_binary,
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  facet_wrap(~ binary_period, ncol = 1, scales = "free_x") +
  labs(
    title = "Évolution des groupes de culture dans le temps",
    y = "Taux de croissance des surfaces cultivées",
    x = "Année"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    strip.text = element_text(size = 12, face = "bold") 
  )


```

Les deux premiers graphiques nous permettent de constater une augmentation sur le long terme des surfaces cultivées pour les groupes de culture que sont les fruits à coque (+3500% par rapport à leur année d'implantation), les "autres cultures industrielles" (+ 2400% par rapport à leur année d'implantation), le tournesol, les plantes à fibres ou encore les protéagineux. Cette expansion de certains groupes de culture et encore plus flagrante lorsqu'on raisonne en terme de nombre de parcelles cultivées, un raisonnement duquel ressort en majorité les mêmes cultures (excepté les vignes qui ont un taux de croissance des parcelles cultivées de 3500% par rapport à leur année de référence alors que leur taux de croissance en termes de surfaces cultivées était plutôt stable) mais avec des taux de croissance des parcelles cultivées exacerbé notamment pour les "autres cultures industrielles" qui fond un bond en 2023 avec +4500% ou encore des fruits à coque qui connaissent une croissance explosive dès 2021 (+3000%) et qui se réitère chaque année depuis. 

A l'inverse, d'autres groupes de culture tendent à stagner sur le long terme voire à décroître (en termes de parcelles) comme les légumes ou fleurs (en termes de surfaces cultivées), les "autres oléagineux" (en termes de parcelles cultivées).

Les deux autres graphiques montrent que : 
* 3 cultures se détachent sur le long terme en matière de taux de croissance de surfaces cultivées : les vignes (ce qui signifie que par rapport à la surface cultivée lors de son année d'implantation, la culture des vignes à fortement augmentée en termes de surface cultivée), les légumineuses à grains et le tournesol.
* Les tendances sont les mêmes en termes de taux de croissance des parcelles cultivées mais encore une fois apparaissent de manière exacerbée. 
* Lorsque l'on raisonne en termes de parcelles cultivées, on voit tout de même davantage de mouvemement sur la période 2007-2012 que pour un raisonnement en termes de surface cultivée. Ainsi, certains groupes de cultures tentent de se détacher quelque peu du reste des groupes de cultures notamment les plantes à fibres en 2009 ou les protéagineux en 2010. Cela est bien moins important que en cette fin de période mais n'est pas à minimiser.

#### \_Etude de 10 premiers et des 10 derniers groupes de culture en termes de taux de croissance moyen de parcelles cultivées\_

```{r - top10_plot_parcels}
# Visualisation top 10 des groupes de culture qui ont le plus cru sur la période 2007-2023, en moyenne 
#Calcul du taux de croissance moyen sur la variable binaire 
top_10_cultures_parcels <- year_by_culture_binary %>%
  group_by(LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    mean_taux_croissance = mean(taux_croissance_parcels_binary, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_taux_croissance)) %>%
  slice(1 : 10) # Sélection des 10 premiers

# Filtrer pour ne garder que les cultures sélectionnées
filtered_data <- year_by_culture_binary %>%
  filter(LIBELLE_GROUPE_CULTURE %in% top_10_cultures_parcels$LIBELLE_GROUPE_CULTURE)

filtered_data %>%
  ggplot(aes(
    x = year,
    y = taux_croissance_parcels_binary,
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  facet_wrap(~ binary_period, ncol = 1, scales = "free_x") +
  labs(
    title = "Évolution des 10 cultures avec le taux de croissance moyen le plus élevé",
    y = "Taux de croissance du nombre de parcelles cultivées",
    x = "Année"
  ) +
  theme_minimal() 

# Visualisation du top 10 des groupes de cultures qui ont le moins cru sur la période 2007-2023, en moyenne
#Calcul du taux de croissance moyen sur la variable binaire 
top_10_cultures_parcels_last <- year_by_culture_binary %>%
  group_by(LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    mean_taux_croissance = mean(taux_croissance_parcels_binary, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(mean_taux_croissance) %>%
  slice(1 : 10) # Sélection des 10 premiers

# Filtrer pour ne garder que les cultures sélectionnées
filtered_data <- year_by_culture_binary %>%
  filter(LIBELLE_GROUPE_CULTURE %in% top_10_cultures_parcels_last$LIBELLE_GROUPE_CULTURE)

filtered_data %>%
  ggplot(aes(
    x = year,
    y = taux_croissance_parcels_binary,
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  facet_wrap(~ binary_period, ncol = 1, scales = "free_x") +
  labs(
    title = "Évolution des 10 cultures avec le taux de croissance moyen le plus faible",
    y = "Taux de croissance du nombre de parcelles cultivées",
    x = "Année"
  ) +
  theme_minimal() 
```

Pour les 10 groupes de cultures avec le taux de croissance moyen le plus élevé : 

On constate qu'encore une fois sur la période 2016-2023, se détache deux cultures : les vignes et le tournesol qui croissent considérablement par rapport à leur année d'implantation. Néanmoins, dès la fin de la période 2007-2015, il y a une croissance de plusieurs cultures par rapport à leur année d'implantation. C'est le cas pour les fuits à coque, les autres cultures industrielles, le fourrage, les estives et landes ou encore les plantes à fibres et les protégaineux. 

Pour les 10 groupes de culture avec le taux de croissance moyen le plus faible : 

On constate cette fois-ci plus d'hétérogénéité avec de la croissance de la par de certains groupes et de la décroissance pour d'autres (autres oléagineux, gel sur la sous-période 2007-2015, prairies temporaires, orge ou légumes ou fleurs sur la sous-période 2016-2023). Nénamoins, s'il y a croissance de certains groupes, celle-ci s'illustre par un taux de croissance bien moins important que pour les 10 autres groupes de cultures étudiés précédemment et surtout ce sont des groupes qui croissent sur la première sous-période mais ceux sont cex mêmes groupes qui décroissent par la suite, par rapport à leur année de référénce. 

Notons également, que la diminution du nombre de parcelles cultivées pour les prairies temporaires (2016-2023) et le gel (2007-2012) laisse donc supposer une mise en culture plus importante des terres agricoles bretonnes. 

Nous répliquons l'analyse aux taux de croissance en termes de surface cultivée :
```{r - top10_plot_surface}
# Visualisation top 10 des groupes de culture qui ont le plus cru sur la période 2007-2023, en moyenne 
#Calcul du taux de croissance moyen sur la variable binaire 
top_10_cultures <- year_by_culture_binary %>%
  group_by(LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    mean_taux_croissance = mean(taux_croissance_surf_binary, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_taux_croissance)) %>%
  slice(1 : 10) # Sélection des 10 premiers

# Filtrer pour ne garder que les cultures sélectionnées
filtered_data <- year_by_culture_binary %>%
  filter(LIBELLE_GROUPE_CULTURE %in% top_10_cultures$LIBELLE_GROUPE_CULTURE)

filtered_data %>%
  ggplot(aes(
    x = year,
    y = as.numeric(taux_croissance_surf_binary),
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  facet_wrap(~ binary_period, ncol = 1, scales = "free_x") +
  labs(
    title = "Évolution des 10 cultures avec le taux de croissance moyen le plus élevé",
    y = "Taux de croissance des surfaces cultivées",
    x = "Année"
  ) +
  theme_minimal() 

# Visualisation du top 10 des groupes de cultures qui ont le moins cru sur la période 2007-2023, en moyenne
#Calcul du taux de croissance moyen sur la variable binaire 
top_10_cultures_last <- year_by_culture_binary %>%
  group_by(LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    mean_taux_croissance = mean(taux_croissance_surf_binary, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(mean_taux_croissance) %>%
  slice(1 : 10) # Sélection des 10 premiers

# Filtrer pour ne garder que les cultures sélectionnées
filtered_data <- year_by_culture_binary %>%
  filter(LIBELLE_GROUPE_CULTURE %in% top_10_cultures_last$LIBELLE_GROUPE_CULTURE)

filtered_data %>%
  ggplot(aes(
    x = year,
    y = as.numeric(taux_croissance_surf_binary),
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  facet_wrap(~ binary_period, ncol = 1, scales = "free_x") +
  labs(
    title = "Évolution des 10 cultures avec le taux de croissance moyen le plus faible",
    y = "Taux de croissance des surfaces cultivées",
    x = "Année"
  ) +
  theme_minimal() 

```

La comparaison avec l'analyse en termes de parcelles cultivées est particulièrement intéressante pour les cultures aux taux de croissance moyen de surface cultivée les plus faibles car si les tendances sont à peu près les mêmes elles sont également d'autant plus visibles dans ce cas-ci. Par exemple on constate clairement la décroissance des prairies temporaires dès 2012 et qui se poursuit jusqu'en 2018, pour stagner jusqu'à 2023, autour de -35% par rapport à leur année d'implantation, autrement dit par rapport à 2007, première date des données dont nous disposons. 

### **Analyse de la diveristé culturale par commune**
```{r}

RPG_R53 %>%
  group_by(year, name) %>%
  summarise(N_Parcels = n_distinct(LIBELLE_GROUPE_CULTURE), .groups = "drop") %>%
  group_by(year) %>%
  summarise(moyenne_cultures = mean(N_Parcels)) %>%
  ggplot(aes(x = year, y = moyenne_cultures)) +
  geom_point(color = "black") +
  labs(title = "Évolution moyenne de la diversité culturale", y = "Nombre moyen de cultures distinctes")
```

Ce graphique montre une augmentation de la diversité culturale moyenne par commune entre 2007 et 2023. Néanmoins, entre 2008 et 2012, on note une sorte de creux et une chute en 2019. 

Nb : travail en diversité culturale moyenne en raison du nombre trop important de données. 

Le but était donc ici de calculer, pour chaque année, le nombre de cultures différentes présentes dans chaque commune et d'en faire la moyenne sur l’ensemble des communes d'une même année.

Ex de lecture : En 2007, la surface agricole des communes de Bretagne était en moyenne composée de 11,1 cultures distinctes alors qu'en 2023, le nombre de cultures distinctes s'élevait à 12,9, soit presque 13. 


```{r}
#Evolution des groupes de cultures dans le temps

RPG_R53 %>%
  group_by(year, LIBELLE_GROUPE_CULTURE) %>%
  summarise(nb_communes = n_distinct(name)) %>%
  ggplot(aes(x = year, y = nb_communes, color = LIBELLE_GROUPE_CULTURE)) +
  geom_point() +
  labs(title = "Evolution des groupes de culture dans le temps",
       y = "Nombre de communes")
```

Ce graphique semble intéressant et pertinent dans l'objectif de comprendre et d'analyser la répartition des cultures dans le temps, sur une région donnée. Néanmoins, même si relativement compréhensible visuellement, de par la multiplicité des données, il reste complexe à analyser plus en profondeur. 

#### \_Calcul de l'indice de Shannon par commune et par année\_
```{r}
# Calcul de l'indice de Shannon
shannon_index <- RPG_R53 %>%
  group_by(year, name, LIBELLE_GROUPE_CULTURE) %>%
  summarise(surface_culture = sum(surf_code_group_m2), .groups = "drop") %>%
  group_by(year, name) %>%
  mutate(total_surface = sum(surface_culture),
         proportion = surface_culture / total_surface) %>%
  summarise(shannon = -sum(proportion * log(proportion), na.rm = TRUE), .groups = "drop") %>%
  group_by(year) %>%
  summarise(moyenne_shannon = mean(shannon, na.rm = TRUE))

# Graphique de la diversité culturale à partir de l'indice de Shannon moyen
ggplot(shannon_index, aes(x = year, y = moyenne_shannon)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "red", size = 2) +
  labs(title = "Évolution de la diversité culturale (Indice de Shannon)",
       x = "Année",
       y = "Indice de Shannon moyen") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

```

L'indice de Shannon, indicateur issu de l'écologie et que l'on chercher à appliquer ici à l'agriculture, mesure la diversité culturale moyenne dans la région entre 2007 et 2023. 

Plus il est élevé, plus la diversité des cultures est importante. 

Ici, on constate : 
* une baisse de la diversité culturale entre 2007 et 2009 
* une forte variabilité entre 2010 et 2019 avec une grosse chute en 2019
* une hausse continue depuis 2020 et donc jusque 2023

*Nb : définition de l'indice de Shanon :*
*H = -Σp(i)xln(p(i))*
*avec :*
*- p(i) la proportion d'une catégorie de culture* 
*- ln, le logarithme naturel*
