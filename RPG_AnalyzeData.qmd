---
title: "RPG Data Analysis - Focus on Bretagne"
author: "Inès Bézie"
format: html
editor: visual
execute:
  echo: false
  message: false
  warning: false
---

```{r}
## Set up environment

# Clean memory 
rm(list=ls())
gc()

# Load package
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, data.table, here, sf, tmap, units, dplyr, kableExtra, knitr, ggplot2)

# List directories 
dir <- list()
dir$root <- here()
dir$data <- here(dir$root, "data")
dir$script <- here(dir$root, "script")
dir$output <- here(dir$root, "output")

# Create non existing directories
lapply(dir, function(i) dir.create(i, recursive = T, showWarnings = F))
```


```{r}

## Load dataset

RPG_R53 <- readRDS("data/RPG_Aggregated_Brittany.rds")

## Color palette
c25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)
```

## Descriptive Statistics

```{r}

summary(RPG_R53)
```


Il semble y avoir des **valeurs extrêmes** dans la répartition des surfaces agricoles cultivées en Bretagne. Cela sa voit par :

- la moyenne des surfaces agricoles cultivées qui est de 14,9 millions de mètres carrées est supérieure à la médiane qui est de 11,8 millions de mètres carrés. 

- la plus grande surface cultivée est de 110 milliards de mètres carrés.

Notons déjà que les valeures minimales 0.00 en termes de surfaces agricoles cultivées sont normales. En effet, les communes bretonnes ne cultivent pas nécessairement l'entiereté des cultures regroupées dans les libellés du RPG. 

Notons également la part importante que représente la culture agricole dans la région de la Bretagne. Remarquons cela en comparant la médiane de la surface des communes à celle de la surface agricole. 

Plus de la moitié des surfaces communales sont des surfaces agricoles : 20520000 m² de surface totale des communes contre 11856787 m² de surface agricole.

Est-ce étonnant d'avoir un groupe de culture couvrant 100% de la surface agricole d'une commune? Cela amènerait à nuancer la diversité culturale étudiée plus bas. 

A noter que lorsqu'on parle en pourcentage, on se retrouve avec 218 valeurs manquantes, mieux vaut peut-être rester sur une analyse en termes de surface? Ces valeurs manquantes peuvent s'expliquer par la division par un dénominateur nul (`N_Parcels`, `surf_code_group_m2`).

```{r}

# Distribution surface agricole

RPG_R53 %>%
  ggplot(aes(x = factor(year), y = surf_agri_geo_unit_m2)) +
  geom_violin(fill = "skyblue", color = "black", alpha = 0.7) +
  geom_boxplot(width = 0.1, fill = "white", outlier.shape = NA, color = "black") + # Ajout d'une boîte 
  labs(title = "Distribution de la surface agricole totale par année en Bretagne (2007-2023)",
       x = "Année", y = "Surface agricole totale (m2)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

D’après la distribution ci-dessus, la majorité des surfaces agricoles cultivées en Bretagne sont inférieures à 30 millions de m², ce qui reflète potentiellement la prédominance de petites et moyennes exploitations agricoles en Bretagne.

A noter qu’en agriculture on parle davantage en hectares qu’en mètres carrés. *1 hectare = 10 000 mètres carrés donc 30 000 000 mètres carrés = 3000 hectares

### Répartition des parcelles par groupe de culture

```{r}

#| echo: false
#| message: false
#| warning: false

# Suggestions Inès : ajouter le nombre de parcelles par culture au graphique (à l'intérieur de chaque colonne)

year_simplified <- c(2007, 2012, 2017, 2023)

RPG_R53_simplified <- RPG_R53 %>%
  filter(year %in% year_simplified)

# Agréger par année et culture
df_parcelles <- RPG_R53_simplified %>%
  group_by(year, LIBELLE_GROUPE_CULTURE) %>%
  summarise(N = sum(N_Parcels, na.rm = TRUE), .groups = "drop")

ggplot(df_parcelles, aes(x = LIBELLE_GROUPE_CULTURE, y = N))  +
  geom_col(fill = "lightgrey") +
  geom_text(aes(label = N), hjust = 1.1, color = "black", size = 2) +
  facet_wrap(~ year, ncol = 2) +
  labs(
    title = "Nombre de parcelles par type de culture",
    x = "Type de culture",
    y = "Nombre de parcelles"
  ) +
  coord_flip() +
  theme_minimal()

# ggsave(here(dir$output, "nombre_parcelles_culture.png"), width = 10, height = 6)
```

### Evolution des groupes de culture dans le temps

```{r}

#| echo: false
#| message: false
#| warning: false

cultures_groupes2 <- RPG_R53 %>%
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE, year) %>%
  summarise(surface_groupe = sum(surf_code_group_m2))

print(cultures_groupes2)

top_cultures_par_an <- cultures_groupes2 %>% 
  group_by(year) %>% 
  slice_max(surface_groupe, n = 3)

print(top_cultures_par_an)
```

De 2007 à 2015, les cultures les plus cultivées (en surface), en Bretagne étaient les "légumes ou fleurs", les "autres céréales" et le "maïs grain et ensillage". Une dynamique qui change quelque peu à partir de 2015 et jusque 2023 : avec le fourrage qui se place en tête du classement au détriment du "Maïs grain et ensillage". 
**A noter que cet effet coincide avec le changement de méthode de calcul du RPG (passage d'ilôts anonymes à parcels cultivés)...**


```{r}

#| echo: false
#| message: false
#| warning: false

cultures_groupes <- RPG_R53 %>%
  group_by(year, CODE_GROUP, LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    surface_groupe = sum(surf_code_group_m2),
    parcels_groupe = sum(parcel_cult_code_group_n),
    .groups = "drop") %>%
  arrange(CODE_GROUP, year) %>% 
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE) %>% 
  mutate(
    taux_croissance = (surface_groupe - lag(surface_groupe)) / lag(surface_groupe) * 100,
    taux_croissance_parcels = (parcels_groupe - lag(parcels_groupe)) / lag(parcels_groupe) * 100
  ) %>%
  mutate(
    mean_taux_croissance = mean(taux_croissance, na.rm = TRUE), 
    mean_taux_croissance_parcels = mean(taux_croissance_parcels, na.rm = TRUE))

# Nuage de point pour représenter la taille de surface par groupe de culture (delete)
plot(
  cultures_groupes$year, 
  cultures_groupes$CODE_GROUP, 
  cex = cultures_groupes$surface_groupe / max(cultures_groupes$surface_groupe, na.rm = TRUE) * 5,  
  col = factor(cultures_groupes$CODE_GROUP),
  xlab = "Année",
  ylab = "Groupe de culture",
  main = "Nuage de points avec taille proportionnelle à la surface agricole",
)
```

Ce graphique nous permet d'analyser plusieurs choses : 

- les cultures dominantes au fil des années en termes de surface agricole occupée : fourrage (16), Légumes ou fleurs (25), Autres céréales (4), Maïs grain et ensillage (2). 

- La variabilité temporelle des cultures : illustration claire d'une fluctuation de la surface agricole associée au fourrage, particulièrement en 2017. 

### Cultures émergentes/cultures en disparition

```{r}

#| echo: false
#| message: false
#| warning: false


#taux de croissance sur la période de culture
year_by_culture_summary <- RPG_R53 %>%
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    annee_min = min(year),
    annee_max = max(year),
    surface_year_min = sum(surf_code_group_m2[year == min(year)], na.rm = TRUE),
    surface_year_max = sum(surf_code_group_m2[year == max(year)], na.rm = TRUE),
    parcels_year_min = sum(parcel_cult_code_group_n[year == min(year)], na.rm = TRUE),
    parcels_year_max = sum(parcel_cult_code_group_n[year == max(year)], na.rm = TRUE),
    taux_croissance_surf = (surface_year_max - surface_year_min) / surface_year_min * 100,
    taux_croissance_parcels = (parcels_year_max - parcels_year_min) / parcels_year_min * 100,
    .groups = "drop"
  )

print(year_by_culture_summary)
```

La dernière culture a être apparue en Bretagne est la vigne, en 2016. 

Si la majorité des cultures sont des cultures stables, présentes depuis le début de la période, 2007, certaines apparraissent plus tardivement dans la période notamment les oliviers, en 2010 et le riz en 2015. 

Il serait intéressant de voir où le riz et les oliviers ont été implantés en Bretagne (nom de la commune)?
```{r}
library(dplyr)

implantations <- RPG_R53 %>%
  filter(LIBELLE_GROUPE_CULTURE %in% c("Oliviers", "Riz"), year >= 2010)

print(implantations)
```

Il faut noter, que les oliviers ne sont cultivés, d'après le RPG, durant une seule année. 
**IMPORTANT : l'implantation de cette culture se fait sur 2 communes : Saint Broladre et Saint Marcan MAIS est associé au nombre de parcelles cultivées d'Oliviers à Saint Broladre : 0 !**
**Nb : problème de nettoyage de données - lié à chevauchement de parcelles entre communes à un seuil < 0,5 - réglé dans le script <05_AggregateData-France>**

Une autre culture se démarque : les légumineuses à grains. Malgré le fait qu'elles couvrent toute la période. Le nombre d'années recensé de leur culture est de 14, cela signifie qu'entre 2007 et 2023, il y a eu une année où il n'y avait pas de cultures de légumineuses à grain sur la surface agricole totale de la Bretagne. 

Nb : Cela peut être soit :
- une piste à creuser afin de déterminer pourquoi les légumineuses à grains n'ont pas été cultivées durant une année 
- un problème dans la base de données ou un facteur externe qui ne s'applique qu'à cette culture et qui peut donc être considéré comme marginal. 

## Analyse de l'évolution du taux de croissance des groupes de culture 

```{r}

#| echo: false
#| message: false
#| warning: false


#nombre de groupes de cultures cultivés dans la région
n_code_groups <- n_distinct(RPG_R53$CODE_GROUP)
print(n_code_groups)
```

Parmi les 29 groupes (exception de deux sans numéro de groupes et d'un "NR"), le libellé le plus cultivé en Bretagne est le "Fourrage", les "Légumes ou fleurs" et d'autres céréales avec respectivement : 434 717 400 000 m²  387 088 000 000 m² et 259 097 100 000 m² de surfaces cultivées. 

A l'inverse, la dernière surface pour laquelle nous possédons des données est le riz avec une surface cultivée faible : 26 125 m².

Ainsi, les agriculteurs bretons cultivent principalement des légumes, des céréales et du fourrage (pour nourrir les bêtes). 




### Carte thermique des variations annuelles (surface)
```{r}

heatmap_data <- RPG_R53 %>%
  group_by(year, LIBELLE_GROUPE_CULTURE) %>%
  summarise(surface_totale = sum(surf_agri_geo_unit_m2, na.rm = TRUE), .groups = "drop") %>%
  ungroup() %>%
  mutate(surface_totale = as.numeric(surface_totale)) 

ggplot(heatmap_data, aes(x = year, y = LIBELLE_GROUPE_CULTURE, fill = surface_totale)) +
  geom_tile() +
  labs(title = "Évolution annuelle des surfaces cultivées par culture",
       fill = "Surface") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### Taux de croissance des surfaces et des parcelles agricoles cultivées, selon les groupes de culture, entre 2007 et 2023.

Dans l'analyse qui suit, nous optons pour une division du groupe en deux "échantillons". En effet, les données dont nous disposons sont issues de deux types de recensement parcellaire : un recensement selon la catégorisation d'îlots anonymes (regroupement d'ensemble de cultures et de parcelles en de plus grands groupes), qui prend fin en 2015 pour laisser place à une catégorisation en cultures parcellaires (analyse plus fine). 

Il s'agit alors d'étudier d'un côté la période 2007-2015 et de l'autre celle 2015-2023, le but étant de se détacher du biais créé par la méthode de calclul des données, biais visible sur les graphiques lors des analyses. 

Pour cela, nous créons une variable binaire.

```{r}

#| echo: false
#| message: false
#| warning: false


year_by_culture_binary <- RPG_R53 %>%
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE, year) %>%
  summarise(
    surface_group = sum(surf_code_group_m2, na.rm = TRUE),
    parcels_cult = sum(parcel_cult_code_group_n, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    binary_period = ifelse(year > 2015, 1, 0) # 1 = 2007-2015, 0 = 2015-2023
  ) %>%
  group_by(CODE_GROUP, LIBELLE_GROUPE_CULTURE, binary_period) %>%
  mutate(
    # Calcul de l'année de base pour chaque période
    min_year = min(year), 
    surface_base = sum(surface_group[year == min_year], na.rm = TRUE),
    parcels_base = sum(parcels_cult[year == min_year], na.rm = TRUE),
    taux_croissance_surf_binary = (surface_group - surface_base) / surface_base * 100,
    taux_croissance_parcels_binary = (parcels_cult - parcels_base) / parcels_base * 100
  ) %>%
  ungroup()
```


```{r}

#| echo: false
#| message: false
#| warning: false


#taux de croissance avec binaire sur les deux périodes : 2007-2015 VS 2015-2023
year_by_culture_binary %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  arrange(year) %>%
  group_by(binary_period, year, LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(
    x = year,
    y = as.numeric(taux_croissance_surf_binary),
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  facet_wrap(~ binary_period, ncol = 1, scales = "free_x") +
  labs(
    title = "Évolution des groupes de culture dans le temps",
    y = "Taux de croissance des surfaces cultivées",
    x = "Année"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    strip.text = element_text(size = 12, face = "bold") # Style des facettes
  )

year_by_culture_binary %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  arrange(year) %>%
  group_by(binary_period, year, LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(
    x = year,
    y = taux_croissance_parcels_binary,
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  facet_wrap(~ binary_period, ncol = 1, scales = "free_x") +
  labs(
    title = "Évolution des groupes de culture dans le temps",
    y = "Taux de croissance des surfaces cultivées",
    x = "Année"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    strip.text = element_text(size = 12, face = "bold") 
  )


```


Voici quelques grandes analyses descriptives que nous pouvons réaliser : 
* En termes de surfaces cultivées, les courbes se chevauchant autour de 0 pour les cultures les plus stables, il est plus aisé de s'attacher aux cultures qui ont tendance à fluctuer au fil des années. 

Trois cultures ont majoritairement les variations les plus importantes, entre croissance et décroissance, c'est-à-dire entre augmentation de la surface cultivée et diminution, marquées donc par une forme d'instabilité, instabilité dont il s'agiriat par la suite de déterminer les déterminants : les légumineuses à grains (courbe pêche), le tournesol (courbe vert pomme) et les plantes à fibres (courbe rose). Des cultures variant, pour les deux premières, entre -100 et 250, avec des pics à des années différentes. Les pics de décroissance ont majoritairement touchés ces deux cultures entre 2007 et 2015, les plus importants étant en 2012 et 2015. A l'inverse, les pics de croissance ont lieu tout au long de la période avec trois paroxysmes : 2011 et 2019 pour les légumineuses à grains et 2018 pour le tournesol. 

Finalement, notons également l'explosion des autres cultures industrielles et des protéagineux en 2023, dont la surface agricole cultivée augmente de plus de 200%.

* En termes de nombre de parcelles cultivées, les résultats sont tout autre. 

Nous pouvons tout d'abord noter qu'il y tout au long de la période augmentation et diminution du nombre de parcelles cultivées ce qui indique qu'il n'y a pas de pertes de disparition de parcelles agricoles par exemple, ou qu'elles sont marginales. Néanmoins, il semble que la croissance des parcelles prend le dessus sur la décroissance. A noter que cela n'est pas nécessairement synonyme d'augmentation des espaces cultivées, car nous n'avons pas d'informations sur la taille de ces parcelles. 

D'autre part, les taux de croissance du nombre de parcelles cultivées par groupe de culture, explosent en 2015, ce qui constitue clairement un artefact statistique. En effet, ce pic soudain d'augmentation du nombre de parcelles cultivées semble inhérent au changement de méthode de mesure parcellaire : passant d'îlots anonymes à cutures parcellaires. Nous analyserons par la suite les variations sur deux sous-périodes distinctes. 

Ce qui ressort de ce graphique, c'est qu'il y a une augmentation depuis 2017 du nombre de parcelles cultivées de tournesol tout comme de plantes à fibre depuis 2020 et que récemment les protéagineux et les cultures industrielles se sont vus attribuer un plus grand nombre de parcelles, avec une croissance d'environ 200%, protégaineux dont le nombre de parcelles cultivées avait par ailleurs explosé en 2010 (+350%) avant de revenir sur une forme de stabilité, signifiant ainsi que le nombre de parcelles cultivées de protéagnieux s'est vu renforcé, étant donné qu'il n'y a pas de décroissance qui compense cette croissance soudaine au cours de la période.

Les deux graphiques montrent que : 
* 3 cultures se détachent sur le long terme en matière de taux de croissance de surfaces cultivées : les vignes (ce qui signifie que par rapport à la surface cultivée lors de son année d'implantation, la culture des vignes à fortement augmentée en termes de surface cultivée), les légumineuses à grains et le tournesol.
* Les tendances sont les mêmes en termes de taux de croissance des parcelles cultivées mais encore une fois apparaissent de manière exacerbée. 
* Lorsque l'on raisonne en termes de parcelles cultivées, on voit tout de même davantage de mouvemement sur la période 2007-2012 que pour un raisonnement en termes de surface cultivée. Ainsi, certains groupes de cultures tentent de se détacher quelque peu du reste des groupes de cultures notamment les plantes à fibres en 2009 ou les protéagineux en 2010. Cela est bien moins important que en cette fin de période mais n'est pas à minimiser.

### Taux de croissance moyen des surfaces et des parcelles agricoles cultivées, selon les groupes de culture, entre 2007 et 2023.

Si les taux de croissance nous informe sur les fluctuations annuelles des cultures, les taux de croissance moyen nous donne une indication sur la tendance générale des cultures au cours du temps.

Cela nous permet notamment de comparer la tendance générale des surfaces cultivées par rapport à celle des parcelles cultivées. 

```{r}

#Graphique selon la moyenne des taux de croissance des surfaces cultivées des groupes de cultures sur la période 2007-2023
cultures_groupes %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  group_by(LIBELLE_GROUPE_CULTURE) %>%
  summarise(taux_croissance_moyen = mean(mean_taux_croissance, na.rm = TRUE)) %>%
  ggplot(aes(x = reorder(LIBELLE_GROUPE_CULTURE, taux_croissance_moyen), y = taux_croissance_moyen, fill = LIBELLE_GROUPE_CULTURE)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c25) +
  labs(title = "Taux de croissance moyen de la surface des groupes de culture (2007-2023)",
       x = NULL, y = "Taux de croissance moyen") +
  theme(legend.position = "none")

# Graphique selon la moyenne des taux de croissance du nombre de parcelles cultivées des groupes de cultures sur la période 2007-2023
cultures_groupes %>%
  filter(!is.na(LIBELLE_GROUPE_CULTURE)) %>%
  group_by(LIBELLE_GROUPE_CULTURE) %>%
  ggplot(aes(x = reorder(LIBELLE_GROUPE_CULTURE, mean_taux_croissance_parcels), y = mean_taux_croissance_parcels, fill = LIBELLE_GROUPE_CULTURE)) +
 geom_col() +
  coord_flip() +
  scale_fill_manual(values = c25) +
  labs(title = "Taux de croissance moyen des parcelles des groupes de culture (2007-2023)",
       y = "Taux de croissance moyen") +
  theme(legend.position = "none")
```

Si nous constatons que quelques cultures se détachent (riz, plantes à fibres, légumineuses à grains, tournseol) du groupe de cultures restant sur une tendance à la stagnation des surfaces cultivées. Pour certaines, en particulier, le riz, ce détachement clair avec environ 50 points de pourcentages de différence avec les plantes à fibres, deuxième culture se détachant le plus en termes de croissance moyenne au cours de la période, est surement du à son implantation tardive (2015) au cours de la période étudiée. 

A noter que potentiellement, à ce stade de l'analyse, même si le riz sera étudié par la suite de manière plus précise, nous pouvons émettre l'hypothèse que le riz n'est pas une culture qui apparaît seulement en 2015 mais bien une culture qui était comprise dans un plus grand sous ensemble de cultures auparavant, lors de la réflexion en termes d'îlots anonymes et ainsi qu'elle émerge comme culture propre avec une analyse plus fine du RPG en termes de cultures parcellaires, à partir de 2015.

Ces tendances générales concordent avec les grands traits que nous avons pu tirer des graphiques illustrant les taux de croissance simples, portant sur le tournesol, les légumineuses à grains ou encore les plantes à fibres. 

Si nous nous attachons à présent au taux de croissance moyen en termes de nombre de parcelles cultivées, nous constatons que le riz n'est plus une culture avec une tendance dominante à la croissance en termes de parcelles cultivées et tend à se fondre dans la masse des autres cultures. Viennent alors à se détacher principalement les plantesà fibres et les vignes. 

La non prégnance du riz sur ce second graphique vient confirmer l'idée que le riz reste une culture minoritaire, qui se concentrent sur un certain nombre, limité de parcelles et qui ne vient pas exploser même si sur le premier graphique elle semble dominante de par sa tendance générale à une croissance en termes de surface cultivée au cours du temps.

A l'inverse, il semble qu'il y ait un véritable intérêt pour les plantes à fibre dont la culture tend en moyenne à croître tant en termes de surface cultivée et que de nombre de parcelles.  

### Analyse des 10 groupes de culture qui ont un taux de croissance moyen le plus élevé (en termes de surfaces cultivées puis en termes de nombre de parcelles cultivées)


```{r}

# Visualisation top 10 des groupes de culture qui ont le plus cru sur la période 2007-2023, en moyenne 
#Calcul du taux de croissance moyen sur la variable binaire 
top_10_cultures <- year_by_culture_binary %>%
  group_by(LIBELLE_GROUPE_CULTURE) %>%
  summarise(
    mean_taux_croissance = mean(taux_croissance_surf_binary, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_taux_croissance)) %>%
  slice(1 : 10) # Sélection des 10 premiers

# Filtrer pour ne garder que les cultures sélectionnées
filtered_data <- year_by_culture_binary %>%
  filter(LIBELLE_GROUPE_CULTURE %in% top_10_cultures$LIBELLE_GROUPE_CULTURE)

filtered_data %>%
  ggplot(aes(
    x = year,
    y = as.numeric(taux_croissance_surf_binary),
    color = LIBELLE_GROUPE_CULTURE,
    group = LIBELLE_GROUPE_CULTURE
  )) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c25) + 
  facet_wrap(~ binary_period, ncol = 1, scales = "free_x") +
  labs(
    title = "Évolution des 10 cultures avec le taux de croissance moyen le plus élevé",
    y = "Taux de croissance des surfaces cultivées",
    x = "Année"
  ) +
  theme_minimal() 

```

Pour les 10 groupes de cultures avec le taux de croissance moyen le plus élevé : 

On constate qu'encore une fois sur la période 2016-2023, se détache deux cultures : les vignes et le tournesol qui croissent considérablement par rapport à leur année d'implantation. Néanmoins, dès la fin de la période 2007-2015, il y a une croissance de plusieurs cultures par rapport à leur année d'implantation. C'est le cas pour les fuits à coque, les autres cultures industrielles, le fourrage, les estives et landes ou encore les plantes à fibres et les protégaineux. 

## Analyse de la diversité culturale par commune

### Evolution moyenne de la diversité culturale

```{r}

RPG_R53 %>%
  group_by(year, name) %>%
  summarise(N_Parcels = n_distinct(LIBELLE_GROUPE_CULTURE), .groups = "drop") %>%
  group_by(year) %>%
  summarise(moyenne_cultures = mean(N_Parcels)) %>%
  ggplot(aes(x = year, y = moyenne_cultures)) +
  geom_col(colour = "lightgrey") +
  labs(title = "Évolution moyenne de la diversité culturale", y = "Nombre moyen de cultures distinctes")
```

Ce graphique montre une augmentation de la diversité culturale moyenne par commune entre 2007 et 2023. Néanmoins, entre 2008 et 2012, on note une sorte de creux et une chute en 2019. 

Nb : travail en diversité culturale moyenne en raison du nombre trop important de données. 

Le but était donc ici de calculer, pour chaque année, le nombre de cultures différentes présentes dans chaque commune et d'en faire la moyenne sur l’ensemble des communes d'une même année.

En 2007, la surface agricole des communes de Bretagne était en moyenne composée de 11,1 cultures distinctes alors qu'en 2023, le nombre de cultures distinctes s'élevait à 12,9, soit presque 13. 

### Indice de Shannon par commune et par année

```{r}

#|echo: false
#|message: false
#|warning: false


# Calcul de l'indice de Shannon
shannon_index <- RPG_R53 %>%
  group_by(year, name, LIBELLE_GROUPE_CULTURE) %>%
  summarise(surface_culture = sum(surf_code_group_m2), .groups = "drop") %>%
  group_by(year, name) %>%
  mutate(total_surface = sum(surface_culture),
         proportion = surface_culture / total_surface) %>%
  summarise(shannon = -sum(proportion * log(proportion), na.rm = TRUE), .groups = "drop") %>%
  group_by(year) %>%
  summarise(moyenne_shannon = mean(shannon, na.rm = TRUE), .groups = "drop")

# Graphique de la diversité culturale à partir de l'indice de Shannon moyen
ggplot(shannon_index, aes(x = year, y = moyenne_shannon, group = 1)) +
  geom_line(color = "#E31A1C", size = 0.5) +
  geom_point(color = "red", size = 2) +
  labs(title = "Évolution de la diversité culturale (Indice de Shannon)",
       x = "Année",
       y = "Indice de Shannon moyen") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

```

L'indice de Shannon, indicateur issu de l'écologie et que l'on chercher à appliquer ici à l'agriculture, mesure la diversité culturale moyenne dans la région entre 2007 et 2023. 

Plus il est élevé, plus la diversité des cultures est importante. 

Ici, on constate : 
* une baisse de la diversité culturale entre 2007 et 2009 
* une forte variabilité entre 2010 et 2019 avec une grosse chute en 2019
* une hausse continue depuis 2020 et donc jusque 2023

*Nb : définition de l'indice de Shanon :*
*H = -Σp(i)xln(p(i))*
*avec :*
*- p(i) la proportion d'une catégorie de culture* 
*- ln, le logarithme naturel*